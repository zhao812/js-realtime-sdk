<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>messages/message.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">leancloud-realtime</a> <span class='package-version'>v3.5.2</span></h2><h3>Classes</h3><ul><li><a href="Conversation.html">Conversation</a><ul class='methods'><li data-type='method'><a href="Conversation.html#add">add</a></li><li data-type='method'><a href="Conversation.html#count">count</a></li><li data-type='method'><a href="Conversation.html#createMessagesIterator">createMessagesIterator</a></li><li data-type='method'><a href="Conversation.html#emit">emit</a></li><li data-type='method'><a href="Conversation.html#fetch">fetch</a></li><li data-type='method'><a href="Conversation.html#fetchReceiptTimestamps">fetchReceiptTimestamps</a></li><li data-type='method'><a href="Conversation.html#get">get</a></li><li data-type='method'><a href="Conversation.html#join">join</a></li><li data-type='method'><a href="Conversation.html#markAsRead">markAsRead</a></li><li data-type='method'><a href="Conversation.html#mute">mute</a></li><li data-type='method'><a href="Conversation.html#off">off</a></li><li data-type='method'><a href="Conversation.html#on">on</a></li><li data-type='method'><a href="Conversation.html#once">once</a></li><li data-type='method'><a href="Conversation.html#queryMessages">queryMessages</a></li><li data-type='method'><a href="Conversation.html#quit">quit</a></li><li data-type='method'><a href="Conversation.html#read">read</a></li><li data-type='method'><a href="Conversation.html#recall">recall</a></li><li data-type='method'><a href="Conversation.html#remove">remove</a></li><li data-type='method'><a href="Conversation.html#save">save</a></li><li data-type='method'><a href="Conversation.html#send">send</a></li><li data-type='method'><a href="Conversation.html#set">set</a></li><li data-type='method'><a href="Conversation.html#setAttribute">setAttribute</a></li><li data-type='method'><a href="Conversation.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="Conversation.html#setName">setName</a></li><li data-type='method'><a href="Conversation.html#unmute">unmute</a></li><li data-type='method'><a href="Conversation.html#update">update</a></li></ul></li><li><a href="ConversationQuery.html">ConversationQuery</a><ul class='methods'><li data-type='method'><a href="ConversationQuery.html#addAscending">addAscending</a></li><li data-type='method'><a href="ConversationQuery.html#addDescending">addDescending</a></li><li data-type='method'><a href="ConversationQuery.html#ascending">ascending</a></li><li data-type='method'><a href="ConversationQuery.html#compact">compact</a></li><li data-type='method'><a href="ConversationQuery.html#containedIn">containedIn</a></li><li data-type='method'><a href="ConversationQuery.html#contains">contains</a></li><li data-type='method'><a href="ConversationQuery.html#containsAll">containsAll</a></li><li data-type='method'><a href="ConversationQuery.html#containsMembers">containsMembers</a></li><li data-type='method'><a href="ConversationQuery.html#descending">descending</a></li><li data-type='method'><a href="ConversationQuery.html#doesNotExist">doesNotExist</a></li><li data-type='method'><a href="ConversationQuery.html#endsWith">endsWith</a></li><li data-type='method'><a href="ConversationQuery.html#equalTo">equalTo</a></li><li data-type='method'><a href="ConversationQuery.html#exists">exists</a></li><li data-type='method'><a href="ConversationQuery.html#find">find</a></li><li data-type='method'><a href="ConversationQuery.html#greaterThan">greaterThan</a></li><li data-type='method'><a href="ConversationQuery.html#greaterThanOrEqualTo">greaterThanOrEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#lessThan">lessThan</a></li><li data-type='method'><a href="ConversationQuery.html#lessThanOrEqualTo">lessThanOrEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#limit">limit</a></li><li data-type='method'><a href="ConversationQuery.html#matches">matches</a></li><li data-type='method'><a href="ConversationQuery.html#notContainsIn">notContainsIn</a></li><li data-type='method'><a href="ConversationQuery.html#notEqualTo">notEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#sizeEqualTo">sizeEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#skip">skip</a></li><li data-type='method'><a href="ConversationQuery.html#startsWith">startsWith</a></li><li data-type='method'><a href="ConversationQuery.html#withLastMessages">withLastMessages</a></li><li data-type='method'><a href="ConversationQuery.html#withLastMessagesRefreshed">withLastMessagesRefreshed</a></li><li data-type='method'><a href="ConversationQuery.html#withMembers">withMembers</a></li></ul></li><li><a href="IMClient.html">IMClient</a><ul class='methods'><li data-type='method'><a href="IMClient.html#close">close</a></li><li data-type='method'><a href="IMClient.html#createConversation">createConversation</a></li><li data-type='method'><a href="IMClient.html#emit">emit</a></li><li data-type='method'><a href="IMClient.html#getConversation">getConversation</a></li><li data-type='method'><a href="IMClient.html#getConversations">getConversations</a></li><li data-type='method'><a href="IMClient.html#getQuery">getQuery</a></li><li data-type='method'><a href="IMClient.html#markAllAsRead">markAllAsRead</a></li><li data-type='method'><a href="IMClient.html#off">off</a></li><li data-type='method'><a href="IMClient.html#on">on</a></li><li data-type='method'><a href="IMClient.html#once">once</a></li><li data-type='method'><a href="IMClient.html#ping">ping</a></li></ul></li><li><a href="Message.html">Message</a><ul class='methods'><li data-type='method'><a href="Message.html#.parse">parse</a></li><li data-type='method'><a href="Message.html#.validate">validate</a></li><li data-type='method'><a href="Message.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="Message.html#setTransient">setTransient</a></li><li data-type='method'><a href="Message.html#toJSON">toJSON</a></li></ul></li><li><a href="global.html#Realtime">Realtime</a><ul class='methods'><li data-type='method'><a href="global.html#Realtime#createIMClient">createIMClient</a></li><li data-type='method'><a href="global.html#Realtime#emit">emit</a></li><li data-type='method'><a href="global.html#Realtime#off">off</a></li><li data-type='method'><a href="global.html#Realtime#on">on</a></li><li data-type='method'><a href="global.html#Realtime#once">once</a></li><li data-type='method'><a href="global.html#Realtime#pause">pause</a></li><li data-type='method'><a href="global.html#Realtime#register">register</a></li><li data-type='method'><a href="global.html#Realtime#resume">resume</a></li><li data-type='method'><a href="global.html#Realtime#retry">retry</a></li></ul></li><li><a href="RecalledMessage.html">RecalledMessage</a><ul class='methods'><li data-type='method'><a href="RecalledMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="RecalledMessage.html#getText">getText</a></li><li data-type='method'><a href="RecalledMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="RecalledMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="RecalledMessage.html#setText">setText</a></li><li data-type='method'><a href="RecalledMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="RecalledMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="TextMessage.html">TextMessage</a><ul class='methods'><li data-type='method'><a href="TextMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="TextMessage.html#getText">getText</a></li><li data-type='method'><a href="TextMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="TextMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="TextMessage.html#setText">setText</a></li><li data-type='method'><a href="TextMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="TextMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="TypedMessage.html">TypedMessage</a><ul class='methods'><li data-type='method'><a href="TypedMessage.html#.parse">parse</a></li><li data-type='method'><a href="TypedMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="TypedMessage.html#getText">getText</a></li><li data-type='method'><a href="TypedMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="TypedMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="TypedMessage.html#setText">setText</a></li><li data-type='method'><a href="TypedMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="TypedMessage.html#toJSON">toJSON</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-leancloud-realtime.html">leancloud-realtime</a><ul class='methods'><li data-type='method'><a href="module-leancloud-realtime.html#.messageField">messageField</a></li><li data-type='method'><a href="module-leancloud-realtime.html#.messageType">messageType</a></li><li data-type='method'><a href="module-leancloud-realtime.html#~defineConversationProperty">defineConversationProperty</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Conversation.html#Events">Conversation</a><ul class='events'><a href="Conversation.html#event:invited">invited</a><a href="Conversation.html#event:kicked">kicked</a><a href="Conversation.html#event:lastdeliveredatupdate">lastdeliveredatupdate</a><a href="Conversation.html#event:lastreadatupdate">lastreadatupdate</a><a href="Conversation.html#event:membersjoined">membersjoined</a><a href="Conversation.html#event:membersleft">membersleft</a><a href="Conversation.html#event:message">message</a><a href="Conversation.html#event:messagerecall">messagerecall</a><a href="Conversation.html#event:messageupdate">messageupdate</a><a href="Conversation.html#event:receipt">receipt</a></ul></li><li><a href="IMClient.html#Events">IMClient</a><ul class='events'><a href="IMClient.html#event:close">close</a><a href="IMClient.html#event:conflict">conflict</a><a href="IMClient.html#event:disconnect">disconnect</a><a href="IMClient.html#event:invited">invited</a><a href="IMClient.html#event:kicked">kicked</a><a href="IMClient.html#event:membersjoined">membersjoined</a><a href="IMClient.html#event:membersleft">membersleft</a><a href="IMClient.html#event:message">message</a><a href="IMClient.html#event:messagerecall">messagerecall</a><a href="IMClient.html#event:messageupdate">messageupdate</a><a href="IMClient.html#event:offline">offline</a><a href="IMClient.html#event:online">online</a><a href="IMClient.html#event:reconnect">reconnect</a><a href="IMClient.html#event:reconnecterror">reconnecterror</a><a href="IMClient.html#event:retry">retry</a><a href="IMClient.html#event:schedule">schedule</a><a href="IMClient.html#event:unreadmessages">unreadmessages</a><a href="IMClient.html#event:unreadmessagescountupdate">unreadmessagescountupdate</a></ul></li><li><a href="global.html#Realtime#Events">Realtime</a><ul class='events'><a href="global.html#Realtime#event:disconnect">disconnect</a><a href="global.html#Realtime#event:offline">offline</a><a href="global.html#Realtime#event:online">online</a><a href="global.html#Realtime#event:reconnect">reconnect</a><a href="global.html#Realtime#event:retry">retry</a><a href="global.html#Realtime#event:schedule">schedule</a></ul></li></ul><h3>Interfaces</h3><ul><li><a href="AVMessage.html">AVMessage</a><ul class='methods'><li data-type='method'><a href="AVMessage.html#.parse">parse</a></li><li data-type='method'><a href="AVMessage.html#.validate">validate</a></li><li data-type='method'><a href="AVMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="Plugin.html">Plugin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ErrorCode">ErrorCode</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">messages/message.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import uuid from 'uuid/v4';


/**
 * 消息状态枚举
 * @enum {Symbol}
 * @since 3.2.0
 * @memberof module:leancloud-realtime
 */
const MessageStatus = {
  /** 初始状态、未知状态 */
  NONE: Symbol('none'),
  /** 正在发送 */
  SENDING: Symbol('sending'),
  /** 已发送 */
  SENT: Symbol('sent'),
  /** 已送达 */
  DELIVERED: Symbol('delivered'),
  /** 发送失败 */
  FAILED: Symbol('failed'),
};
Object.freeze(MessageStatus);

const rMessageStatus = {
  [MessageStatus.NONE]: true,
  [MessageStatus.SENDING]: true,
  [MessageStatus.SENT]: true,
  [MessageStatus.DELIVERED]: true,
  [MessageStatus.READ]: true,
  [MessageStatus.FAILED]: true,
};

export { MessageStatus };
export default class Message {
  /**
   * @implements AVMessage
   * @param  {Object|String} content 消息内容
   */
  constructor(content) {
    Object.assign(this, { content }, {
      /**
       * @type {String}
       * @memberof Message#
       */
      id: uuid(),
      /**
       * 消息所在的 conversation id
       * @memberof Message#
       * @type {String?}
       */
      cid: null,
      /**
       * 消息发送时间
       * @memberof Message#
       * @type {Date}
       */
      timestamp: new Date(),
      /**
       * 消息发送者
       * @memberof Message#
       * @type {String}
       */
      from: undefined,
      /**
       * 标记需要回执
       * @memberof Message#
       * @type {Boolean}
       * @deprecated 指定是否需要送达回执请使用 {@link Conversation#send} 方法的 `options.receipt` 参数。
       */
      needReceipt: false,
      /**
       * 标记暂态消息
       * @memberof Message#
       * @type {Boolean}
       * @deprecated 指定是否作为暂态消息发送请使用 {@link Conversation#send} 方法的 `options.transient` 参数。
       * 请不要将是否为暂态作为区分某些消息的标记，请使用富媒体消息的属性（attributes）或使用自定义消息类型。
       * 该字段将在 v4.0 中移除。
       */
      transient: false,
      /**
       * @var deliveredAt {?Date} 消息送达时间
       * @memberof Message#
       */
      // deliveredAt,
    });
    this._setStatus(MessageStatus.NONE);
  }

  /**
   * 设置是否需要送达回执
   * @param {Boolean} needReceipt
   * @return {Message} self
   * @deprecated 请使用 {@link Conversation#send} 方法的 `options.receipt` 选项代替。
   */
  setNeedReceipt(needReceipt) {
    console.warn('DEPRECATION Message#setNeedReceipt: Use Conversation#send with sendOptions.receipt instead.');
    this.needReceipt = needReceipt;
    return this;
  }

  /**
   * 设置是否是暂态消息
   * @param {Boolean} transient
   * @return {Message} self
   * @deprecated 请使用 {@link Conversation#send} 方法的 `options.transient` 选项代替。
   */
  setTransient(transient) {
    console.warn('DEPRECATION Message#setTransient: Use Conversation#send with sendOptions.transient instead.');
    this.transient = transient;
    return this;
  }

  /**
   * 将当前消息序列化为 JSON 对象
   * @protected
   * @return {Object}
   */
  toJSON() {
    return this.content;
  }

  /**
   * 消息状态，值为 {@link module:leancloud-realtime.MessageStatus} 之一
   * @type {Symbol}
   * @readonly
   * @since 3.2.0
   */
  get status() {
    return this._status;
  }

  _setStatus(status) {
    if (!rMessageStatus[status]) {
      throw new Error('Invalid message status');
    }
    this._status = status;
  }

  /**
   * 消息修改或撤回时间，可以通过比较其与消息的 timestamp 是否相等判断消息是否被修改过或撤回过。
   * @type {Date}
   * @since 3.5.0
   */
  get updatedAt() {
    return this._updatedAt || this.timestamp;
  }
  set updatedAt(value) {
    this._updatedAt = value;
  }

  /**
   * 判断给定的内容是否是有效的 Message，
   * 该方法始终返回 true
   * @protected
   * @returns {Boolean}
   * @implements AVMessage.validate
   */
  static validate() {
    return true;
  }

  /**
   * 解析处理消息内容
   * &lt;pre>
   * 如果子类提供了 message，返回该 message
   * 如果没有提供，将 json 作为 content 实例化一个 Message
   * @protected
   * @param  {Object}  json    json 格式的消息内容
   * @param  {Message} message 子类提供的 message
   * @return {Message}
   * @implements AVMessage.parse
   */
  static parse(json, message) {
    return message || new this(json);
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Jun 30 2017 06:39:02 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
