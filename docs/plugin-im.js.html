<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>plugin-im.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">leancloud-realtime</a> <span class='package-version'>v3.5.2</span></h2><h3>Classes</h3><ul><li><a href="Conversation.html">Conversation</a><ul class='methods'><li data-type='method'><a href="Conversation.html#add">add</a></li><li data-type='method'><a href="Conversation.html#count">count</a></li><li data-type='method'><a href="Conversation.html#createMessagesIterator">createMessagesIterator</a></li><li data-type='method'><a href="Conversation.html#emit">emit</a></li><li data-type='method'><a href="Conversation.html#fetch">fetch</a></li><li data-type='method'><a href="Conversation.html#fetchReceiptTimestamps">fetchReceiptTimestamps</a></li><li data-type='method'><a href="Conversation.html#get">get</a></li><li data-type='method'><a href="Conversation.html#join">join</a></li><li data-type='method'><a href="Conversation.html#markAsRead">markAsRead</a></li><li data-type='method'><a href="Conversation.html#mute">mute</a></li><li data-type='method'><a href="Conversation.html#off">off</a></li><li data-type='method'><a href="Conversation.html#on">on</a></li><li data-type='method'><a href="Conversation.html#once">once</a></li><li data-type='method'><a href="Conversation.html#queryMessages">queryMessages</a></li><li data-type='method'><a href="Conversation.html#quit">quit</a></li><li data-type='method'><a href="Conversation.html#read">read</a></li><li data-type='method'><a href="Conversation.html#recall">recall</a></li><li data-type='method'><a href="Conversation.html#remove">remove</a></li><li data-type='method'><a href="Conversation.html#save">save</a></li><li data-type='method'><a href="Conversation.html#send">send</a></li><li data-type='method'><a href="Conversation.html#set">set</a></li><li data-type='method'><a href="Conversation.html#setAttribute">setAttribute</a></li><li data-type='method'><a href="Conversation.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="Conversation.html#setName">setName</a></li><li data-type='method'><a href="Conversation.html#unmute">unmute</a></li><li data-type='method'><a href="Conversation.html#update">update</a></li></ul></li><li><a href="ConversationQuery.html">ConversationQuery</a><ul class='methods'><li data-type='method'><a href="ConversationQuery.html#addAscending">addAscending</a></li><li data-type='method'><a href="ConversationQuery.html#addDescending">addDescending</a></li><li data-type='method'><a href="ConversationQuery.html#ascending">ascending</a></li><li data-type='method'><a href="ConversationQuery.html#compact">compact</a></li><li data-type='method'><a href="ConversationQuery.html#containedIn">containedIn</a></li><li data-type='method'><a href="ConversationQuery.html#contains">contains</a></li><li data-type='method'><a href="ConversationQuery.html#containsAll">containsAll</a></li><li data-type='method'><a href="ConversationQuery.html#containsMembers">containsMembers</a></li><li data-type='method'><a href="ConversationQuery.html#descending">descending</a></li><li data-type='method'><a href="ConversationQuery.html#doesNotExist">doesNotExist</a></li><li data-type='method'><a href="ConversationQuery.html#endsWith">endsWith</a></li><li data-type='method'><a href="ConversationQuery.html#equalTo">equalTo</a></li><li data-type='method'><a href="ConversationQuery.html#exists">exists</a></li><li data-type='method'><a href="ConversationQuery.html#find">find</a></li><li data-type='method'><a href="ConversationQuery.html#greaterThan">greaterThan</a></li><li data-type='method'><a href="ConversationQuery.html#greaterThanOrEqualTo">greaterThanOrEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#lessThan">lessThan</a></li><li data-type='method'><a href="ConversationQuery.html#lessThanOrEqualTo">lessThanOrEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#limit">limit</a></li><li data-type='method'><a href="ConversationQuery.html#matches">matches</a></li><li data-type='method'><a href="ConversationQuery.html#notContainsIn">notContainsIn</a></li><li data-type='method'><a href="ConversationQuery.html#notEqualTo">notEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#sizeEqualTo">sizeEqualTo</a></li><li data-type='method'><a href="ConversationQuery.html#skip">skip</a></li><li data-type='method'><a href="ConversationQuery.html#startsWith">startsWith</a></li><li data-type='method'><a href="ConversationQuery.html#withLastMessages">withLastMessages</a></li><li data-type='method'><a href="ConversationQuery.html#withLastMessagesRefreshed">withLastMessagesRefreshed</a></li><li data-type='method'><a href="ConversationQuery.html#withMembers">withMembers</a></li></ul></li><li><a href="IMClient.html">IMClient</a><ul class='methods'><li data-type='method'><a href="IMClient.html#close">close</a></li><li data-type='method'><a href="IMClient.html#createConversation">createConversation</a></li><li data-type='method'><a href="IMClient.html#emit">emit</a></li><li data-type='method'><a href="IMClient.html#getConversation">getConversation</a></li><li data-type='method'><a href="IMClient.html#getConversations">getConversations</a></li><li data-type='method'><a href="IMClient.html#getQuery">getQuery</a></li><li data-type='method'><a href="IMClient.html#markAllAsRead">markAllAsRead</a></li><li data-type='method'><a href="IMClient.html#off">off</a></li><li data-type='method'><a href="IMClient.html#on">on</a></li><li data-type='method'><a href="IMClient.html#once">once</a></li><li data-type='method'><a href="IMClient.html#ping">ping</a></li></ul></li><li><a href="Message.html">Message</a><ul class='methods'><li data-type='method'><a href="Message.html#.parse">parse</a></li><li data-type='method'><a href="Message.html#.validate">validate</a></li><li data-type='method'><a href="Message.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="Message.html#setTransient">setTransient</a></li><li data-type='method'><a href="Message.html#toJSON">toJSON</a></li></ul></li><li><a href="global.html#Realtime">Realtime</a><ul class='methods'><li data-type='method'><a href="global.html#Realtime#createIMClient">createIMClient</a></li><li data-type='method'><a href="global.html#Realtime#emit">emit</a></li><li data-type='method'><a href="global.html#Realtime#off">off</a></li><li data-type='method'><a href="global.html#Realtime#on">on</a></li><li data-type='method'><a href="global.html#Realtime#once">once</a></li><li data-type='method'><a href="global.html#Realtime#pause">pause</a></li><li data-type='method'><a href="global.html#Realtime#register">register</a></li><li data-type='method'><a href="global.html#Realtime#resume">resume</a></li><li data-type='method'><a href="global.html#Realtime#retry">retry</a></li></ul></li><li><a href="RecalledMessage.html">RecalledMessage</a><ul class='methods'><li data-type='method'><a href="RecalledMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="RecalledMessage.html#getText">getText</a></li><li data-type='method'><a href="RecalledMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="RecalledMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="RecalledMessage.html#setText">setText</a></li><li data-type='method'><a href="RecalledMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="RecalledMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="TextMessage.html">TextMessage</a><ul class='methods'><li data-type='method'><a href="TextMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="TextMessage.html#getText">getText</a></li><li data-type='method'><a href="TextMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="TextMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="TextMessage.html#setText">setText</a></li><li data-type='method'><a href="TextMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="TextMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="TypedMessage.html">TypedMessage</a><ul class='methods'><li data-type='method'><a href="TypedMessage.html#.parse">parse</a></li><li data-type='method'><a href="TypedMessage.html#getAttributes">getAttributes</a></li><li data-type='method'><a href="TypedMessage.html#getText">getText</a></li><li data-type='method'><a href="TypedMessage.html#setAttributes">setAttributes</a></li><li data-type='method'><a href="TypedMessage.html#setNeedReceipt">setNeedReceipt</a></li><li data-type='method'><a href="TypedMessage.html#setText">setText</a></li><li data-type='method'><a href="TypedMessage.html#setTransient">setTransient</a></li><li data-type='method'><a href="TypedMessage.html#toJSON">toJSON</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-leancloud-realtime.html">leancloud-realtime</a><ul class='methods'><li data-type='method'><a href="module-leancloud-realtime.html#.messageField">messageField</a></li><li data-type='method'><a href="module-leancloud-realtime.html#.messageType">messageType</a></li><li data-type='method'><a href="module-leancloud-realtime.html#~defineConversationProperty">defineConversationProperty</a></li></ul></li></ul><h3>Events</h3><ul><li><a href="Conversation.html#Events">Conversation</a><ul class='events'><a href="Conversation.html#event:invited">invited</a><a href="Conversation.html#event:kicked">kicked</a><a href="Conversation.html#event:lastdeliveredatupdate">lastdeliveredatupdate</a><a href="Conversation.html#event:lastreadatupdate">lastreadatupdate</a><a href="Conversation.html#event:membersjoined">membersjoined</a><a href="Conversation.html#event:membersleft">membersleft</a><a href="Conversation.html#event:message">message</a><a href="Conversation.html#event:messagerecall">messagerecall</a><a href="Conversation.html#event:messageupdate">messageupdate</a><a href="Conversation.html#event:receipt">receipt</a></ul></li><li><a href="IMClient.html#Events">IMClient</a><ul class='events'><a href="IMClient.html#event:close">close</a><a href="IMClient.html#event:conflict">conflict</a><a href="IMClient.html#event:disconnect">disconnect</a><a href="IMClient.html#event:invited">invited</a><a href="IMClient.html#event:kicked">kicked</a><a href="IMClient.html#event:membersjoined">membersjoined</a><a href="IMClient.html#event:membersleft">membersleft</a><a href="IMClient.html#event:message">message</a><a href="IMClient.html#event:messagerecall">messagerecall</a><a href="IMClient.html#event:messageupdate">messageupdate</a><a href="IMClient.html#event:offline">offline</a><a href="IMClient.html#event:online">online</a><a href="IMClient.html#event:reconnect">reconnect</a><a href="IMClient.html#event:reconnecterror">reconnecterror</a><a href="IMClient.html#event:retry">retry</a><a href="IMClient.html#event:schedule">schedule</a><a href="IMClient.html#event:unreadmessages">unreadmessages</a><a href="IMClient.html#event:unreadmessagescountupdate">unreadmessagescountupdate</a></ul></li><li><a href="global.html#Realtime#Events">Realtime</a><ul class='events'><a href="global.html#Realtime#event:disconnect">disconnect</a><a href="global.html#Realtime#event:offline">offline</a><a href="global.html#Realtime#event:online">online</a><a href="global.html#Realtime#event:reconnect">reconnect</a><a href="global.html#Realtime#event:retry">retry</a><a href="global.html#Realtime#event:schedule">schedule</a></ul></li></ul><h3>Interfaces</h3><ul><li><a href="AVMessage.html">AVMessage</a><ul class='methods'><li data-type='method'><a href="AVMessage.html#.parse">parse</a></li><li data-type='method'><a href="AVMessage.html#.validate">validate</a></li><li data-type='method'><a href="AVMessage.html#toJSON">toJSON</a></li></ul></li><li><a href="Plugin.html">Plugin</a></li></ul><h3>Global</h3><ul><li><a href="global.html#ErrorCode">ErrorCode</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">plugin-im.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** @module leancloud-realtime */
import d from 'debug';
import uuid from 'uuid/v4';
import IMClient from './im-client';
import Conversation from './conversation';
import Message, { MessageStatus } from './messages/message';
import TextMessage from './messages/text-message';
import TypedMessage from './messages/typed-message';
import RecalledMessage from './messages/recalled-message';
import MessageParser from './message-parser';
import { trim, internal, ensureArray } from './utils';

const debug = d('LC:IMPlugin');

/**
 * 消息优先级枚举
 * @enum {Number}
 * @since 3.3.0
 */
const MessagePriority = {
  /** 高 */
  HIGH: 1,
  /** 普通 */
  NORMAL: 2,
  /** 低 */
  LOW: 3,
};
Object.freeze(MessagePriority);

/**
 * 为 Conversation 定义一个新属性
 * @param {String} prop 属性名
 * @param {Object} [descriptor] 属性的描述符，参见 {@link https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/getOwnPropertyDescriptor#Description getOwnPropertyDescriptor#Description - MDN}，默认为该属性名对应的 Conversation 自定义属性的 getter/setter
 * @returns void
 * @example
 *
 * conversation.get('type');
 * conversation.set('type', 1);
 *
 * // equals to
 * defineConversationProperty('type');
 * conversation.type;
 * conversation.type = 1;
 */
const defineConversationProperty = (prop, descriptor = {
  get() { return this.get(prop); },
  set(value) { this.set(prop, value); },
}) => {
  Object.defineProperty(Conversation.prototype, prop, descriptor);
};

export {
  /**
   * @see Message
   */
  Message,
  /**
   * @see TypedMessage
   */
  TypedMessage,
  /**
   * @see TextMessage
   */
  TextMessage,
  /**
   * @see RecalledMessage
   */
  RecalledMessage,
  MessagePriority,
  MessageStatus,
  defineConversationProperty,
};

export {
  /**
   * decorator，定义消息类的类型常量
   * @function
   * @param {Number} type 自定义类型请使用正整数
   * @example @messageType(1)
   * class CustomMessage extends TypedMessage {}
   *
   * // 不支持 decorator 的情况下可以这样使用
   * class CustomMessage extends TypedMessage {
   *   //...
   * }
   * messageType(1)(CustomMessage);
   */
  messageType,
  /**
   * decorator，定义消息类的自定义字段
   * @function
   * @param {String[]} fields 自定义字段
   * @example @messageField(['foo'])
   * class CustomMessage extends TypedMessage {
   *   constructor(foo) {
   *     super();
   *     this.foo = foo;
   *   }
   * }
   *
   * // 不支持 decorator 的情况下可以这样使用
   * class CustomMessage extends TypedMessage {
   *   constructor(foo) {
   *     super();
   *     this.foo = foo;
   *   }
   *   //...
   * }
   * messageField(['foo'])(CustomMessage);
   */
  messageField,
  IE10Compatible,
} from './messages/helpers';

const onRealtimeCreate = (realtime) => {
  /* eslint-disable no-param-reassign */
  const deviceId = uuid();
  realtime._IMClients = {};
  const messageParser = realtime._messageParser = new MessageParser(realtime._plugins);

  /**
   * 注册消息类
   *
   * 在接收消息、查询消息时，会按照消息类注册顺序的逆序依次尝试解析消息内容
   *
   * @function register
   * @memberof Realtime
   * @instance
   * @param  {Function | Function[]} messageClass 消息类，需要实现 {@link AVMessage} 接口，
   * 建议继承自 {@link TypedMessage}
   * @throws {TypeError} 如果 messageClass 没有实现 {@link AVMessage} 接口则抛出异常
   */
  realtime.register = messageClass =>
    ensureArray(messageClass).map(messageParser.register.bind(messageParser));
  realtime.register(ensureArray(realtime._plugins.messageClasses));
  /**
   * 创建一个即时通讯客户端，多次创建相同 id 的客户端会返回同一个实例
   * @function createIMClient
   * @memberof Realtime
   * @instance
   * @param  {String} [id] 客户端 id，如果不指定，服务端会随机生成一个
   * @param  {Object} [clientOptions] 详细参数 @see {@link IMClient}
   * @param  {String} [tag] 客户端类型标记，以支持单点登录功能
   * @return {Promise.&lt;IMClient>}
   */
  realtime.createIMClient = (id, clientOptions, tag) => {
    const idIsString = typeof id === 'string';
    if (idIsString &amp;&amp; realtime._IMClients[id] !== undefined) {
      return Promise.resolve(realtime._IMClients[id]);
    }
    const promise = realtime._open().then((connection) => {
      const client = new IMClient(id, clientOptions, connection, {
        _messageParser: messageParser,
        _plugins: realtime._plugins,
      });
      connection.on('reconnect', () =>
        client._open(realtime._options.appId, tag, deviceId, true)
          /**
           * 客户端连接恢复正常，该事件通常在 {@link Realtime#event:reconnect} 之后发生
           * @event IMClient#reconnect
           * @see Realtime#event:reconnect
           * @since 3.2.0
           */
          /**
           * 客户端重新登录发生错误（网络连接已恢复，但重新登录错误）
           * @event IMClient#reconnecterror
           * @since 3.2.0
           */
          .then(
            () => client.emit('reconnect'),
            error => client.emit('reconnecterror', error)
          )
      );
      internal(client)._eventemitter.on('close', () => {
        delete realtime._IMClients[client.id];
        realtime._deregister(client);
      }, realtime);
      return client._open(realtime._options.appId, tag, deviceId)
        .then(() => {
          realtime._IMClients[client.id] = client;
          realtime._register(client);
          return client;
        });
    });
    if (idIsString) {
      realtime._IMClients[id] = promise;
    }
    return promise;
  };
  /* eslint-enable no-param-reassign */
};

const beforeCommandDispatch = (command, realtime) => {
  if (command.peerId === null) return true;
  const targetClient = realtime._IMClients[command.peerId];
  if (targetClient) {
    targetClient._dispatchCommand(command).catch(debug);
  } else {
    debug(
      '[WARN] Unexpected message received without any live client match: %O',
      trim(command)
    );
  }
  return false;
};

export const IMPlugin = {
  name: 'leancloud-realtime-plugin-im',
  onRealtimeCreate,
  beforeCommandDispatch,
  messageClasses: [
    Message,
    RecalledMessage,
    TextMessage,
  ],
};
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a> on Fri Jun 30 2017 06:39:02 GMT+0000 (UTC) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
